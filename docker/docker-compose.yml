version: "3.4"

services:
  app:
    hostname: ${HOSTNAME}
    image: emlab/tutorial/fetch:noetic
    build:
      context: ./
      dockerfile: Dockerfile
    container_name: emlab-tutorial-client
    volumes:
      - type: bind
        source: "/tmp/.X11-unix"
        target: "/tmp/.X11-unix"
      - type: bind
        source: "${XDG_RUNTIME_DIR}/gdm/Xauthority"
        target: "${XDG_RUNTIME_DIR}/gdm/Xauthority"
      # Init environement variables
      - type: bind
        source: ../catkin_ws/app/src
        target: /home/docker/catkin_ws/src
      - type: bind
        source: ../catkin_ws/app/dist-packages
        target: /home/docker/catkin_ws/dist-packages
      - type: bind
        source: ./env/ros_env.sh
        target: /home/docker/env/ros_env.sh
    environment:
      # Display X Server GUIs.
      DISPLAY: ${DISPLAY}
      QT_X11_NO_MITSHM: 1
      # ID.
      USER_NAME: ${APP_USER_NAME}
      HOST_UID: ${HOST_UID}
      HOST_GID: ${HOST_GID}
      # PulseAudio.
      PULSE_SERVER: unix:${XDG_RUNTIME_DIR}/pulse/native
    network_mode: host
    privileged: true
    tty: true
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
